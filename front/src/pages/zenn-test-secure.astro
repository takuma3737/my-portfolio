---
// GitHub APIå‹•ä½œãƒ†ã‚¹ãƒˆãƒšãƒ¼ã‚¸ï¼ˆã‚»ã‚­ãƒ¥ã‚¢ç‰ˆï¼‰
import Layout from "../layouts/Layout.astro";

// ç’°å¢ƒå¤‰æ•°ã®ãƒ‡ãƒãƒƒã‚°
console.log("ğŸ” ç’°å¢ƒå¤‰æ•°ãƒ‡ãƒãƒƒã‚°:");
console.log(
  "GITHUB_TOKEN:",
  process.env.GITHUB_TOKEN
    ? `è¨­å®šæ¸ˆã¿ (${process.env.GITHUB_TOKEN.substring(0, 10)}...)`
    : "æœªè¨­å®š"
);
console.log("ZENN_GITHUB_USERNAME:", process.env.ZENN_GITHUB_USERNAME);
console.log("ZENN_REPO_NAME:", process.env.ZENN_REPO_NAME);
console.log("NODE_ENV:", process.env.NODE_ENV);

// Zenn APIé–¢æ•°ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
const { fetchZennArticlesWithCache } = await import("../lib/zenn-api");

// Zennè¨˜äº‹ã‚’å–å¾—ã—ã¦ãƒ†ã‚¹ãƒˆ
const zennResult = await fetchZennArticlesWithCache();

// ãƒ‡ãƒãƒƒã‚°ç”¨ã®ã‚³ãƒ³ã‚½ãƒ¼ãƒ«å‡ºåŠ›
console.log("ğŸ” Zenn API ãƒ†ã‚¹ãƒˆçµæœ:", {
  success: zennResult.success,
  articlesCount: zennResult.data?.length || 0,
  error: zennResult.error,
});

// ç’°å¢ƒå¤‰æ•°ã®ç¢ºèª
const envCheck = {
  githubToken: process.env.GITHUB_TOKEN ? "âœ… è¨­å®šæ¸ˆã¿" : "âŒ æœªè¨­å®š",
  username: process.env.ZENN_GITHUB_USERNAME || "âŒ æœªè¨­å®š", 
  repoName: process.env.ZENN_REPO_NAME || "âŒ æœªè¨­å®š",
};
---

<Layout title="Zenn API ãƒ†ã‚¹ãƒˆ">
  <main class="max-w-4xl mx-auto p-6">
    <h1 class="text-3xl font-bold mb-6 text-gray-900">
      ğŸ” Zenn API å‹•ä½œãƒ†ã‚¹ãƒˆ
    </h1>

    <!-- ç’°å¢ƒå¤‰æ•°ã®çŠ¶æ…‹ -->
    <div class="bg-gray-50 p-4 rounded-lg mb-6">
      <h2 class="text-lg font-semibold mb-4">ğŸ› ï¸ ç’°å¢ƒå¤‰æ•°ã®çŠ¶æ…‹</h2>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
        <div>
          <div class="font-medium text-gray-600">GitHub Token</div>
          <div class="font-mono text-sm">{envCheck.githubToken}</div>
        </div>
        <div>
          <div class="font-medium text-gray-600">Username</div>
          <div class="font-mono text-sm">{envCheck.username}</div>
        </div>
        <div>
          <div class="font-medium text-gray-600">Repository</div>
          <div class="font-mono text-sm">{envCheck.repoName}</div>
        </div>
      </div>
    </div>

    <!-- API ãƒ†ã‚¹ãƒˆçµæœ -->
    <div class="bg-white border rounded-lg p-6">
      <h2 class="text-lg font-semibold mb-4">ğŸ“Š API ãƒ†ã‚¹ãƒˆçµæœ</h2>

      <div class="mb-6">
        {
          zennResult.success ? (
            <div class="space-y-4">
              <div class="flex items-center gap-2">
                <span class="text-2xl">âœ…</span>
                <span class="text-green-700 font-semibold">APIæ¥ç¶šæˆåŠŸï¼</span>
              </div>

              <div class="bg-green-50 p-4 rounded-lg">
                <div class="text-sm text-green-700">
                  <strong>å–å¾—è¨˜äº‹æ•°:</strong> {zennResult.data?.length || 0}ä»¶
                </div>
                <div class="text-sm text-green-700">
                  <strong>ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸:</strong> {zennResult.message}
                </div>
              </div>

              {zennResult.data && zennResult.data.length > 0 && (
                <div>
                  <h3 class="font-semibold mb-3">
                    ğŸ“„ å–å¾—ã—ãŸè¨˜äº‹ä¸€è¦§ï¼ˆæœ€æ–°5ä»¶ï¼‰
                  </h3>
                  <div class="space-y-3">
                    {zennResult.data.slice(0, 5).map((article: any, index: number) => (
                      <div class="bg-gray-50 p-3 rounded border-l-4 border-blue-400">
                        <div class="font-medium text-gray-900">
                          {article.title}
                        </div>
                        <div class="text-sm text-gray-600 mt-1">
                          {article.emoji} â€¢ ä½œæˆ: {article.date} â€¢ ãƒ‘ã‚¹:{" "}
                          {article.path}
                        </div>
                        {article.topics && article.topics.length > 0 && (
                          <div class="flex gap-1 mt-2">
                            {article.topics.map((topic: string, topicIndex: number) => (
                              <span
                                class="px-2 py-1 bg-blue-100 text-blue-700 text-xs rounded"
                              >
                                {topic}
                              </span>
                            ))}
                          </div>
                        )}
                      </div>
                    ))}
                  </div>
                  {zennResult.data.length > 5 && (
                    <div class="text-sm text-gray-500 mt-3">
                      ... ãã®ä»– {zennResult.data.length - 5}ä»¶ã®è¨˜äº‹
                    </div>
                  )}
                </div>
              )}
            </div>
          ) : (
            <div class="space-y-4">
              <div class="flex items-center gap-2">
                <span class="text-2xl">âŒ</span>
                <span class="text-red-700 font-semibold">APIæ¥ç¶šå¤±æ•—</span>
              </div>

              <div class="bg-red-50 p-4 rounded-lg">
                <div class="text-sm text-red-700">
                  <strong>ã‚¨ãƒ©ãƒ¼:</strong> {zennResult.error}
                </div>
              </div>

              <div class="bg-yellow-50 p-4 rounded-lg">
                <h3 class="font-semibold text-yellow-800 mb-2">
                  ğŸ” ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°
                </h3>
                <ul class="text-sm text-yellow-700 space-y-1">
                  <li>â€¢ GitHub Personal Access TokenãŒæ­£ã—ãè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª</li>
                  <li>â€¢ Tokenã«ãƒªãƒã‚¸ãƒˆãƒªã®èª­ã¿å–ã‚Šæ¨©é™ãŒã‚ã‚‹ã‹ç¢ºèª</li>
                  <li>â€¢ ãƒªãƒã‚¸ãƒˆãƒªåï¼ˆzenn-articleï¼‰ãŒæ­£ã—ã„ã‹ç¢ºèª</li>
                  <li>â€¢ articlesãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèª</li>
                  <li>â€¢ Tokenã®æœ‰åŠ¹æœŸé™ãŒåˆ‡ã‚Œã¦ã„ãªã„ã‹ç¢ºèª</li>
                </ul>
              </div>
            </div>
          )
        }
      </div>

      <!-- ãƒ‡ãƒãƒƒã‚°æƒ…å ± -->
      <div class="border-t pt-4 mt-6">
        <h3 class="font-semibold mb-3">ğŸ” è©³ç´°ãƒ‡ãƒãƒƒã‚°æƒ…å ±</h3>
        <div class="bg-gray-50 p-3 rounded font-mono text-xs overflow-x-auto">
          <pre>{JSON.stringify(zennResult, null, 2)}</pre>
        </div>
      </div>

      <!-- ãƒªãƒã‚¸ãƒˆãƒªãƒªãƒ³ã‚¯ -->
      <div class="border-t pt-4 mt-6">
        <h3 class="font-semibold mb-3">ğŸ”— å‚ç…§ä¸­ã®ãƒªãƒã‚¸ãƒˆãƒª</h3>
        <div class="text-sm">
          <a
            href={`https://github.com/${envCheck.username}/${envCheck.repoName}`}
            target="_blank"
            rel="noopener noreferrer"
            class="text-blue-600 hover:text-blue-800 underline"
          >
            https://github.com/{envCheck.username}/{envCheck.repoName}
          </a>
        </div>
      </div>
    </div>

    <!-- ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
    <div class="mt-8 text-center">
      <a
        href="/"
        class="inline-block bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700 transition-colors"
      >
        â† ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹
      </a>
    </div>
  </main>
</Layout>