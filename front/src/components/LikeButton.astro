---
interface Props {
    articleSlug: string;
}

const { articleSlug } = Astro.props;
---

<div class="bg-white p-4 rounded-xl shadow-sm border border-gray-200/50 mt-6">
    <div class="flex items-center justify-between">
        <h3 class="font-medium text-gray-700">ã“ã®è¨˜äº‹ã¯ã„ã‹ãŒã§ã—ãŸã‹ï¼Ÿ</h3>
        <div class="flex items-center gap-4">
            <!-- ã„ã„ã­ãƒœã‚¿ãƒ³ -->
            <button 
                id="like-button"
                class="flex items-center gap-2 px-4 py-2 rounded-lg transition-all duration-200 hover:scale-105"
                data-article-slug={articleSlug}
            >
                <span id="like-icon" class="text-xl">ğŸ‘</span>
                <span id="like-text" class="font-medium">ã„ã„ã­</span>
                <span id="like-count" class="bg-gray-100 text-gray-600 px-2 py-1 rounded-full text-sm font-medium">0</span>
            </button>
        </div>
    </div>
    
    <!-- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
    <div id="like-message" class="mt-3 text-center text-sm" style="display: none;"></div>
</div>

<script define:vars={{ articleSlug }}>
    // LocalStorageã®ã‚­ãƒ¼
    const LIKES_KEY = `likes_${articleSlug}`;
    const USER_LIKED_KEY = `user_liked_${articleSlug}`;

    // è¦ç´ ã®å–å¾—
    const likeButton = document.getElementById('like-button');
    const likeIcon = document.getElementById('like-icon');
    const likeText = document.getElementById('like-text');
    const likeCount = document.getElementById('like-count');
    const likeMessage = document.getElementById('like-message');

    // ã„ã„ã­æ•°ã‚’å–å¾—
    function getLikeCount() {
        try {
            const count = localStorage.getItem(LIKES_KEY);
            return count ? parseInt(count, 10) : 0;
        } catch (error) {
            console.error('ã„ã„ã­æ•°ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ:', error);
            return 0;
        }
    }

    // ã„ã„ã­æ•°ã‚’ä¿å­˜
    function setLikeCount(count) {
        try {
            localStorage.setItem(LIKES_KEY, count.toString());
        } catch (error) {
            console.error('ã„ã„ã­æ•°ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ:', error);
        }
    }

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã„ã„ã­æ¸ˆã¿ã‹ãƒã‚§ãƒƒã‚¯
    function hasUserLiked() {
        try {
            return localStorage.getItem(USER_LIKED_KEY) === 'true';
        } catch (error) {
            console.error('ã„ã„ã­çŠ¶æ…‹ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ:', error);
            return false;
        }
    }

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã„ã„ã­çŠ¶æ…‹ã‚’ä¿å­˜
    function setUserLiked(liked) {
        try {
            localStorage.setItem(USER_LIKED_KEY, liked.toString());
        } catch (error) {
            console.error('ã„ã„ã­çŠ¶æ…‹ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ:', error);
        }
    }

    // UIã‚’æ›´æ–°
    function updateUI() {
        const count = getLikeCount();
        const userLiked = hasUserLiked();

        likeCount.textContent = count.toString();

        if (userLiked) {
            // ã„ã„ã­æ¸ˆã¿ã®çŠ¶æ…‹ï¼ˆå–ã‚Šæ¶ˆã—å¯èƒ½ï¼‰
            likeButton.className = 'flex items-center gap-2 px-4 py-2 rounded-lg transition-all duration-200 hover:scale-105 bg-blue-50 border border-blue-200 text-blue-700 hover:bg-blue-100 hover:border-blue-300';
            likeIcon.textContent = 'ğŸ‘';
            likeText.textContent = 'ã„ã„ã­æ¸ˆã¿';
            likeButton.disabled = false;
            likeButton.title = 'ã‚¯ãƒªãƒƒã‚¯ã§ã„ã„ã­ã‚’å–ã‚Šæ¶ˆã—';
        } else {
            // ã„ã„ã­å¯èƒ½ãªçŠ¶æ…‹
            likeButton.className = 'flex items-center gap-2 px-4 py-2 rounded-lg transition-all duration-200 hover:scale-105 bg-gray-50 border border-gray-200 text-gray-700 hover:bg-blue-50 hover:border-blue-200 hover:text-blue-700';
            likeIcon.textContent = 'ğŸ‘';
            likeText.textContent = 'ã„ã„ã­';
            likeButton.disabled = false;
            likeButton.title = 'ã„ã„ã­ã™ã‚‹';
        }
    }

    // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
    function showMessage(text, type = 'success') {
        likeMessage.textContent = text;
        likeMessage.className = `mt-3 text-center text-sm ${
            type === 'success' ? 'text-green-600' :
            type === 'error' ? 'text-red-600' :
            'text-blue-600'
        }`;
        likeMessage.style.display = 'block';

        // 3ç§’å¾Œã«éè¡¨ç¤º
        setTimeout(() => {
            likeMessage.style.display = 'none';
        }, 3000);
    }

    // ã„ã„ã­å‡¦ç†ï¼ˆãƒˆã‚°ãƒ«æ©Ÿèƒ½ä»˜ãï¼‰
    function handleLike() {
        const currentlyLiked = hasUserLiked();
        const currentCount = getLikeCount();

        if (currentlyLiked) {
            // ã„ã„ã­ã‚’å–ã‚Šæ¶ˆã™
            const newCount = Math.max(0, currentCount - 1); // 0æœªæº€ã«ãªã‚‰ãªã„ã‚ˆã†ã«
            setLikeCount(newCount);
            setUserLiked(false);

            // UIã‚’æ›´æ–°
            updateUI();

            // å–ã‚Šæ¶ˆã—ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
            showMessage('ã„ã„ã­ã‚’å–ã‚Šæ¶ˆã—ã¾ã—ãŸ', 'info');

            // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³åŠ¹æœ
            likeButton.style.transform = 'scale(0.95)';
            setTimeout(() => {
                likeButton.style.transform = 'scale(1)';
            }, 200);
        } else {
            // ã„ã„ã­ã™ã‚‹
            const newCount = currentCount + 1;
            setLikeCount(newCount);
            setUserLiked(true);

            // UIã‚’æ›´æ–°
            updateUI();

            // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
            showMessage('ã„ã„ã­ã—ã¾ã—ãŸï¼ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ğŸ‰', 'success');

            // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³åŠ¹æœ
            likeButton.style.transform = 'scale(1.1)';
            setTimeout(() => {
                likeButton.style.transform = 'scale(1)';
            }, 200);
        }
    }

    // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®è¨­å®š
    document.addEventListener('DOMContentLoaded', function() {
        // åˆæœŸçŠ¶æ…‹ã®è¨­å®š
        updateUI();

        // ã„ã„ã­ãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
        if (likeButton) {
            likeButton.addEventListener('click', handleLike);
        }
    });
</script>
